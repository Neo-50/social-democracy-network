<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>YouTube Widget</title>
  <style>
    #input-section {
      margin-top: 10px;
    }
    input[type="text"] {
      padding: 8px;
      width: 80%;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <iframe id="player" src="" allowfullscreen width="560" height="315"></iframe>

  <div id="input-section">
    <input type="text" id="youtubeUrl" placeholder="Paste a YouTube link here and press Enter..." />
  </div>

  <!-- âœ… This is the correct working Matrix widget API script -->
  <script src="/media/widgets/matrix-widget-api.js"></script>

  <script>
    const input = document.getElementById("youtubeUrl");
    const player = document.getElementById("player");

    const widgetApi = new window.MatrixWidgetApi();
    widgetApi.start();
    widgetApi.send('content_loaded');

    widgetApi.observeEvent("m.room.message", async (event) => {
      try {
        const content = event?.data?.content;
        const sender = event?.data?.sender;
        console.log("ðŸ“© New message from:", sender, content);

        if (!content || content.msgtype !== "m.text") return;

        const id = extractYouTubeID(content.body || "");
        if (id) {
          console.log("ðŸŽ¯ Found YouTube ID:", id);
          setVideo(id);
        }
      } catch (err) {
        console.error("âŒ Error handling m.room.message:", err);
      }
    });

    function extractYouTubeID(url) {
      const match = url.match(/[?&]v=([^&]+)/);
      return match ? match[1] : null;
    }

    function setVideo(id) {
      if (id) {
        const embedUrl = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
        player.src = embedUrl;
        input.value = `https://youtube.com/watch?v=${id}`;
        console.log("âœ… Set video:", id);
      } else {
        console.warn("âš ï¸ Invalid YouTube ID");
      }
    }

    // Load from query param if provided
    const urlParams = new URLSearchParams(window.location.search);
    const initialID = urlParams.get("v");
    if (initialID) setVideo(initialID);

    // Handle manual input
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const id = extractYouTubeID(input.value);
        setVideo(id);
      }
    });

    // ðŸ”Œ Matrix widget event integration
    window.addEventListener("message", (event) => {
      const data = event.data;
      if (!data || data.api !== "fromWidget") return;

      const content = data?.data?.content;
      const body = content?.body;
      if (typeof body === "string" && body.includes("youtube.com/watch?v=")) {
        const id = extractYouTubeID(body);
        if (id) {
          console.log("ðŸŽ¬ Auto-playing from message:", id);
          setVideo(id);
        }
      }
    });
  </script>
</body>
</html>
