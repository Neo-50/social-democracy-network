{% extends 'base.html' %}
{% block content %}

<main class="messages-main-wrapper">
    <h2>Send New Message</h2>
    <div class="send-new-message">
        <form class="new-message-form" id="new-message-form">
            <div class="write-message-wrapper">
                <select name="recipient_id" id="recipient_id" required>
                    <option value="" disabled selected>Select a user</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>

                <textarea name="content" placeholder="Write your message..." required></textarea>
                <button class="inbox-button" type="submit">Send</button>
            </div>
        </form>
    </div>

    <h2>Message Threads</h2>

    <div class="message-threads">
        <div class="conversation-list">
            {% for user in conversations %}
                <div class="thread-item">
                    <a href="{{ url_for('messages', username=user.username) }}">
                    ðŸ’¬ {{ user.username }}
                    </a>
                </div>
            {% else %}
                No messages yet.
            {% endfor %}
        </div>
        <div class="messages-container">
            {% for msg in messages %}
                <div class="message-wrapper">
                    <div class="message {{ 'sent' if msg.sender_id == session['user_id'] else 'received' }}">
                        <div class="content">{{ msg.content }}</div>
                        <div class="meta">{{ msg.sender.username }} â€¢ {{ msg.timestamp.strftime('%m-%d-%Y %H:%M') }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <form id="message-form" class="message-form">
            <div class="message-input-container">
                <input type="hidden" name="recipient_id" value="{{ recipient.id }}">
                <input class="compose-message" name="content" placeholder="Write a message..." required />
            </div>
        </form>
          
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const newMessageForm = document.getElementById('new-message-form');
            if (newMessageForm) {
                newMessageForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const formData = new FormData(newMessageForm);
                    const response = await fetch('/api/send_message', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast('Message sent!');
                        newMessageForm.reset();
                    } else {
                        alert(result.error || 'Message failed to send.');
                    }
                });
            }

            const messageForm = document.getElementById('message-form');
            if (messageForm) {
                messageForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const formData = new FormData(messageForm);
                    const response = await fetch('/api/send_message', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const text = await response.text();
                        console.error('Server error:', text);
                        throw new Error('Server error');
                    }

                    const result = await response.json();
                    if (result.success) {
                        const msg = result.message;
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('message-wrapper', 'sent');
                        messageDiv.innerHTML = `
                            <div class="message sent">
                                <div class="content">${msg.content}</div>
                                <div class="meta">${msg.sender.username} â€¢ ${msg.timestamp}</div>
                            </div>
                        `;
                        document.querySelector('.messages-container').appendChild(messageDiv);
                        messageDiv.scrollIntoView({ behavior: 'smooth' });
                        messageForm.querySelector('input[name="content"]').value = '';
                    } else {
                        alert(result.error || 'Failed to send message.');
                    }
                });
            }
        });
    </script>        
</main>

{% endblock %}
