{% extends 'base.html' %}
{% block content %}

<main class="messages-main-wrapper">
    <h2>Send New Message</h2>
    <form method="POST" class="message-form">
        <div class="write-message-wrapper" action="{{ url_for('messages', username=recipient.username) }}">
            <select name="recipient_id" id="recipient_id" required>
                <option value="" disabled selected>Select a user</option>
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>

            <textarea name="content" placeholder="Write your message..." required></textarea>
            <button class="inbox-button" type="submit">Send</button>
        </div>
    </form>

    <h2>Message Threads</h2>

    <div class="message-threads">
        <div class="conversation-list">
            {% for user in conversations %}
                <div class="thread-item">
                    <a href="{{ url_for('messages', username=user.username) }}">
                    ðŸ’¬ {{ user.username }}
                    </a>
                </div>
            {% else %}
                No messages yet.
            {% endfor %}
        </div>
        <div class="messages-container">
            {% for msg in messages %}
                <div class="message-wrapper">
                    <div class="message {{ 'sent' if msg.sender_id == session['user_id'] else 'received' }}">
                        <div class="content">{{ msg.content }}</div>
                        <div class="meta">{{ msg.sender.username }} â€¢ {{ msg.timestamp.strftime('%m-%d-%Y %H:%M') }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <form id="message-form" class="message-form">
            <div class="message-input-container">
                <input type="hidden" name="recipient_id" value="{{ recipient.id }}">
                <input class="compose-message" name="content" placeholder="Write a message..." required />
            </div>
        </form>
          
    </div>
    <script>
        document.getElementById('message-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            const response = await fetch('/api/send_message', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const text = await response.text();
                console.error('Server error:', text);
                throw new Error('Server error');
            }

            const result = await response.json();

            if (result.success) {
                const msg = result.message;

                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message-wrapper', 'sent');
                messageDiv.innerHTML = `
                    <div class="message sent">
                        <div class="content">${msg.content}</div>
                        <div class="meta">${msg.sender.username} â€¢ ${msg.timestamp}</div>
                    </div>
                `;

                document.querySelector('.messages-container').appendChild(messageDiv);

                // âœ… Must go here, while messageDiv is still in scope
                messageDiv.scrollIntoView({ behavior: 'smooth' });

                // Clear input
                form.querySelector('input[name="content"]').value = '';
            }
        });
    </script>        
</main>

{% endblock %}
