{% extends 'base.html' %}

{% block content %}
<main class="news-page">

    <!-- Submission Form -->
    <section class="news-left">
        <h2>Submit a News Link</h2>
        <form method="POST" action="{{ url_for('news') }}">
            <input type="url" name="url" placeholder="Paste news article URL here..." required>
            <br><button type="submit">Submit</button>
        </form>
    </section>

    <!-- News Feed and Comments in unified right section -->
    <section class="news-right">
        {% for article in articles %}
        <div class="news-article">
            <h2><a href="{{ article.url }}" target="_blank">{{ article.title }}</a></h2>
            <p>{{ article.description }}</p>
            <p><em>Source: {{ article.source }}</em></p>
            <p><em>Published: {{ article.published }}</em></p>
            <img src="{{ article.image_url }}" alt="Article image" width="100%" class="news-image">
            


            <div class="comments-thread">
                <h4>Discussion</h4>

                {% for comment in article.comments if comment.parent_id is none %}
                <div class="comment">
                    <strong class="username">
                        {{ comment.user.username if comment.user else 'Anonymous' }}
                        {% if comment.user and comment.user.is_admin %}
                            <span class="admin-badge" title="Admin">🛡️</span>
                        {% endif %}
                    </strong>

                    <div class="comment-header">
                        <p>{{ comment.content }}</p>
                    </div>
                    
                    <div class="comment-toolbar">
                        <button class="vote-button upvote">▲</button>
                        <span class="vote-count">0</span>
                        <button class="vote-button downvote">▼</button>
                        <button class="reply-toggle">Reply</button>

                        {% if session.get('user_id') and (session['user_id'] == comment.user_id or is_admin()) %}
                        <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" class="delete-form">
                            <button type="submit" onclick="return confirm('Delete this comment?')" class="delete-button">🗑 Delete</button>
                        </form>
                        {% endif %}
                    </div>
                    <div class="reply-drawer" style="display: none;">
                        <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <textarea name="content" placeholder="Write a reply..." required></textarea>
                            <button type="submit">Submit</button>
                            <button type="button" class="cancel-reply">Cancel</button>
                        </form>
                    </div>
                </div>
                <div class="replies" style="margin-left: 20px;">
                    {% for reply in comment.replies %}
                    <div class="reply">
                        <div class="reply-content">
                            <strong class="username">
                                {{ comment.user.username if comment.user else 'Anonymous' }}
                                {% if comment.user and comment.user.is_admin %}
                                    <span class="admin-badge" title="Admin">🛡️</span>
                                {% endif %}
                            </strong>
                            <p>{{ reply.content }}</p>
                            
                            <div class="comment-toolbar">
                                <button class="vote-button upvote">▲</button>
                                <span class="vote-count">0</span>
                                <button class="vote-button downvote">▼</button>
                                <button class="reply-toggle">Reply</button>

                                {% if session.get('user_id') and (session['user_id'] == reply.user_id or is_admin()) %}
                                <form method="POST" action="{{ url_for('delete_comment', comment_id=reply.id) }}" class="delete-form">
                                    <button type="submit" onclick="return confirm('Delete this reply?')" class="delete-button">🗑 Delete</button>
                                </form>
                                {% endif %}
                            </div>
                            <div class="reply-drawer" style="display: none;">
                                <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                                    <input type="hidden" name="parent_id" value="{{ reply.id }}">
                                    <textarea name="content" placeholder="Write a reply..." required></textarea>
                                    <button type="submit">Submit</button>
                                    <button type="button" class="cancel-reply">Cancel</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}

                {% if session.get('user_id') %}
                <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                    <textarea name="content" placeholder="Write a comment..." required></textarea>
                    <button type="submit" class="post-comment">Post Comment</button>
                </form>
                {% else %}
                <p><a href="{{ url_for('login') }}">Log in</a> to comment.</p>
                {% endif %}
            </div>

        {% if is_admin() %}
        <form method="POST" action="{{ url_for('delete_article', article_id=article.id) }}" style="display:inline;">
            <button type="submit" class="delete-button" onclick="return confirm('Delete this article?')">🗑 Delete Article</button>
        </form>
        {% endif %}
        </div>
        {% endfor %}
    </section>
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.reply-toggle').forEach(button => {
        button.addEventListener('click', () => {
            const wrapper = button.closest('.comment, .reply');
            const drawer = wrapper.querySelector('.reply-drawer');
            if (drawer) {
                drawer.style.display = drawer.style.display === 'none' ? 'block' : 'none';
            }
        });
    });

    document.querySelectorAll('.cancel-reply').forEach(button => {
        button.addEventListener('click', (e) => {
            const drawer = e.target.closest('.reply-drawer');
            if (drawer) {
                drawer.style.display = 'none';
            }
        });
    });
});
</script>

</main>
{% endblock %}
