{% extends 'base.html' %}

{% block content %}
{% macro render_comment(comment, article, depth=0) %}
    <div class="comments-thread" data-comment-id="{{ comment.id }}">
        <div class="comment-container">
            <div class="comment-header">
                {% if comment.user %}
                <img src="{{ url_for('avatar', filename=comment.user.avatar_filename or 'default_avatar.png') }}" class="avatar-inline"
                    alt="User Avatar">
                {% else %}
                <img src="{{ url_for('avatar', filename='default_avatar.png') }}" class="avatar-inline" alt="User Avatar">
                {% endif %}              
                <strong class="username">
                    {% if comment.user %}
                        {{ comment.user.username }}
                        {% if comment.user.is_admin %}
                        <span class="admin-badge" title="Admin">üõ°Ô∏è</span>
                    {% endif %}
                    {% else %}
                        Anonymous
                    {% endif %}
                </strong>
            </div>

            <div class="comment-content">
                <p>{{ comment.content }}</p>
            </div>

            <div class="comment-toolbar" data-comment-id="{{ comment.id }}">
                {% if depth < 3 %}
                    <button class="newsfeed-button reply-toggle">Reply</button>
                {% endif %}
                {% if current_user.is_authenticated and (current_user.id == comment.user_id or current_user_obj.is_admin) %}
                    <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}"
                        class="delete-form">
                        <button type="submit" onclick="return confirm('Delete this comment?')"
                        class="delete-button">üóë Delete</button>
                    </form>
                {% endif %}
            </div>
            {% if depth < 3 %} 
                <div class="reply-drawer" style="display: none;">
                    <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                        <textarea name="content" placeholder="Write a reply..." required></textarea>
                        <button type="submit" class="newsfeed-button">Submit</button>
                        <button type="button" class="newsfeed-button cancel-reply">Cancel</button>
                    </form>
                </div>
            {% endif %}
        </div>
        <div class="reply-container">
            {% if comment.replies %}
                {% for reply in comment.replies %}
                    {{ render_comment(reply, article, depth + 1) }}
                {% endfor %}
            {% endif %}
        </div>
    </div>
{% endmacro %}

<main class="news-page">
    <!-- Submission Form -->
    <section class="news-left">
        <form method="POST" action="{{ url_for('news') }}">
            <div class="submit-article-container">
                <input type="url" name="url" placeholder="Paste news article URL here..." required>
                <button type="submit" class="submit-article">Submit</button>
            </div>
        </form>
        {% for article in articles %}
            <div class="news-article">
                <div class="article-info">
                    <h2><a href="{{ article.url }}" target="_blank">{{ article.title }}</a></h2>
                    <p>{{ article.description }}</p>
                    <p><em>Source: {{ article.source }}</em></p>
                    <p><em>Published: {{ article.published }}</em></p>
                </div>
                <img src="{{ article.image_url }}" alt="Article image" width="100%" class="news-image">

                <div class="comments-wrapper">
                    <h2>Discussion</h2>
                    <div class="comments-thread">
                        {% for comment in article.comments if comment.parent_id is none %}
                            {{ render_comment(comment, article) }}
                        {% endfor %}
                    </div>
                </div>
                <div class="post-comment-container">
                    {% if session.get('user_id') %}
                        <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                            <textarea name="content" placeholder="Write a comment..." required></textarea>
                            <button type="submit" class="post-comment">Post Comment</button>
                        </form>
                    {% else %}
                        <p><a href="{{ url_for('login') }}" class="newsfeed-button">Log in</a> to comment.</p>
                    {% endif %}
                </div>
                {% if is_admin() or current_user_obj.id == article.user_id %}
                    <form method="POST" action="{{ url_for('delete_article', article_id=article.id) }}" style="display:inline;">
                        <button type="submit" class="delete-button" onclick="return confirm('Delete this article?')">üóë Delete
                            Article</button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
    </section>

    <section class="news-right">
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.reply-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const wrapper = button.closest('.comment-container');
                    const drawer = wrapper.querySelector('.reply-drawer');
                    if (drawer) {
                        drawer.style.display = drawer.style.display === 'none' ? 'block' : 'none';
                    }
                });
            });

            document.querySelectorAll('.cancel-reply').forEach(button => {
                button.addEventListener('click', (e) => {
                    const drawer = e.target.closest('.reply-drawer');
                    if (drawer) {
                        drawer.style.display = 'none';
                    }
                });
            });
        });
    </script>

</main>
{% endblock %}