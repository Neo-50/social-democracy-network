{% extends 'base.html' %}

{% block content %}
{% macro render_comment(comment, article, depth=0) %}
    <div class="comments-thread" data-comment-id="{{ comment.id }}">
        <div class="comment-container">
            <div class="comment-header">
                {% if comment.user %}
                <img src="{{ url_for('avatar', filename=comment.user.avatar_filename or 'default_avatar.png') }}" class="avatar-inline"
                    alt="User Avatar">
                {% else %}
                <img src="{{ url_for('avatar', filename='default_avatar.png') }}" class="avatar-inline" alt="User Avatar">
                {% endif %}
                <strong class="username">
                    {% if comment.user %}
                        {{ comment.user.username }}
                        {% if comment.user.is_admin %}
                        <span class="admin-badge" title="Admin">üõ°Ô∏è</span>
                    {% endif %}
                    {% else %}
                        Anonymous
                    {% endif %}
                </strong>
            </div>

            <div class="comment-content">
                <p>{{ comment.content }}</p>
            </div>

            <div class="comment-toolbar" data-comment-id="{{ comment.id }}">
                <span class="comment-timestamp" data-timestamp="{{ comment.timestamp.isoformat() }}Z">
                    {{ comment.timestamp.strftime('%B %d, %Y %I:%M %p') }}
                </span>

                {% if depth < 3 %}
                    <button class="newsfeed-button reply-toggle">Reply</button>
                {% endif %}
                {% if current_user.is_authenticated and (current_user.id == comment.user_id or current_user_obj.is_admin) %}
                    <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}"
                        class="delete-form">
                        <button type="submit" onclick="return confirm('Delete this comment?')"
                        class="delete-button">üóë Delete</button>
                    </form>
                {% endif %}
            </div>
            {% if depth < 3 %}
                <div class="reply-drawer" style="display: none;">
                    <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                        <textarea name="content" placeholder="Write a reply..." required></textarea>
                        <button type="submit" class="newsfeed-button">Submit</button>
                        <button type="button" class="newsfeed-button cancel-reply">Cancel</button>
                    </form>
                </div>
            {% endif %}
        </div>
        <div class="reply-container">
            {% if comment.replies %}
                {% for reply in comment.replies %}
                    {{ render_comment(reply, article, depth + 1) }}
                {% endfor %}
            {% endif %}
        </div>
    </div>
{% endmacro %}

<main class="news-page">
    <section class="news-left">
        <form method="POST" action="{{ url_for('news') }}">
            <div class="submit-article-container">
                <input type="url" name="url" placeholder="Paste news article URL here..." required>
                <button type="submit" class="submit-article">Submit</button>
            </div>
            <select name="category" id="category">
                <option value="">Uncategorized</option>
                <option value="War Military & Conflict">War Military & Conflict</option>
                <option value="ICE & Immigration">ICE Raids & Immigration</option>
                <option value="Political Corruption">US Political Corruption</option>
                <option value="Protests & Activism">Protests & Activism</option>
                <option value="Climate & Environment">Climate & Environment</option>
                <option value="Science & Technology">Science & Technology</option>
                <option value="Economy & Finance">Economy & Finance</option>
            </select>
            <div class="category-links">
                <ul>
                    <li><a href="{{ url_for('news') }}">All</a></li>
                    <li><a href="{{ url_for('news', category='War Military & Conflict') }}">War Military & Conflict</a></li>
                    <li><a href="{{ url_for('news', category='ICE & Immigration') }}">Immigration ICE Raids & Abductions</a></li>
                    <li><a href="{{ url_for('news', category='Political Corruption') }}">US Political Corruption</a></li>
                    <li><a href="{{ url_for('news', category='Protests & Activism') }}">Protests & Activism</a></li>
                    <li><a href="{{ url_for('news', category='Climate & Environment') }}">Climate & Environment</a></li>
                    <li><a href="{{ url_for('news', category='Science & Technology') }}">Science & Technology</a></li>
                    <li><a href="{{ url_for('news', category='Economy & Finance') }}">Economy & Finance</a></li>
                </ul>
            </div>
        </form>

    </section>

    <section class="news-right">
        {% if selected_category %}
            <h2>{{ selected_category }}</h2>
        {% else %}
            <h2>All Categories</h2>
        {% endif %}

        <form method="get" class="sort-form" style="margin-bottom: 1em;">
            {% if selected_category %}
                <input type="hidden" name="category" value="{{ selected_category }}">
            {% endif %}
            <label for="sort">Sort by:</label>
            <select name="sort" id="sort" onchange="this.form.submit()">
                <option value="desc" {% if request.args.get('sort') == 'desc' %}selected{% endif %}>Newest First</option>
                <option value="asc" {% if request.args.get('sort') == 'asc' %}selected{% endif %}>Oldest First</option>
            </select>
        </form>

        {% for article in articles %}
            <div class="news-article">
                <div class="article-info">
                    <h2><a href="{{ article.url }}" target="_blank">{{ article.title or 'None' }}</a></h2>
                    <p>Description: {{ article.description or 'None' }}</p>
                    <p>Source: {{ article.source or 'None' }}</p>
                    {% if article.published %}
                        <p>Published: {{ article.published | datetimeformat("%B %d, %Y") or 'None' }}</p>
                    {% else %}
                        <p>Published: None</p>
                    {% endif %}
                    <p>Category: {{ article.category or 'None' }}</p>
                </div>
                <img src="{{ article.image_url }}" alt="Article image" width="100%" class="news-image">

                <div class="comments-wrapper">
                    <h2>Discussion</h2>
                    <div class="comments-thread">
                        {% for comment in article.comments if comment.parent_id is none %}
                            {{ render_comment(comment, article) }}
                        {% endfor %}
                    </div>
                </div>
                <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                    <div class="post-comment-container">
                        {% if session.get('user_id') %}
                                <textarea name="content" placeholder="Write a comment..." required></textarea>
                                <button type="submit" class="post-comment">Post Comment</button>
                        {% else %}
                            <p><a href="{{ url_for('login') }}" class="newsfeed-button">Log in</a> to comment.</p>
                        {% endif %}
                    </div>
                </form>
                {% if is_admin() %}
                    <form method="POST" action="{{ url_for('edit_article', article_id=article.id) }}" class="article-edit-form">
                        Title: <input name="title" value="{{ article.title or '' }}">
                        Description: <textarea name="description">{{ article.description or '' }}</textarea>
                        Source: <input name="source" value="{{ article.source or '' }}">
                        Published: <input type="date" name="published" value="{{ article.published or '' }}">
                        <button type="submit" class="newsfeed-button">Update</button>
                    </form>
                {% endif %}
                <form method="POST" action="{{ url_for('update_article_category', article_id=article.id) }}">
                    <div class="new-category-container">
                        {% if is_admin() or current_user_obj.id == article.user_id %}
                            <select name="new-category" id="new-category">
                                <option value="">Uncategorized</option>
                                <option value="War Military & Conflict">War Military & Conflict</option>
                                <option value="ICE & Immigration">Immigration ICE Raids Abductions</option>
                                <option value="Political Corruption">US Political Corruption</option>
                                <option value="Protests & Activism">Protests & Activism</option>
                                <option value="Climate & Environment">Climate & Environment</option>
                                <option value="Science & Technology">Science & Technology</option>
                                <option value="Economy & Finance">Economy & Finance</option>
                            </select>
                            <button type="submit" class="newsfeed-button">Update</button>
                        {% endif %}
                    </div>
                </form>
                {% if is_admin() or current_user_obj.id == article.user_id %}
                    <form method="POST" action="{{ url_for('delete_article', article_id=article.id) }}" style="display:inline;">
                        <button type="submit" class="delete-button" onclick="return confirm('Delete this article?')">üóë Delete
                            Article</button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
    </section>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.reply-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const wrapper = button.closest('.comment-container');
                    const drawer = wrapper.querySelector('.reply-drawer');
                    if (drawer) {
                        drawer.style.display = drawer.style.display === 'none' ? 'block' : 'none';
                    }
                });
            });

            document.querySelectorAll('.cancel-reply').forEach(button => {
                button.addEventListener('click', (e) => {
                    const drawer = e.target.closest('.reply-drawer');
                    if (drawer) {
                        drawer.style.display = 'none';
                    }
                });
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const timestampElements = document.querySelectorAll('.comment-timestamp');
            timestampElements.forEach(el => {
                const utcIso = el.dataset.timestamp;
                if (!utcIso) return;

                const date = new Date(utcIso);
                const options = {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: 'numeric', minute: 'numeric',
                    hour12: true,
                };
                const localTime = new Intl.DateTimeFormat(undefined, options).format(date);
                el.textContent = localTime;
                console.log("Timestamp:", utcIso, "‚Üí", date.toString());
            });
        });
    </script>
</main>
{% endblock %}