{% extends 'base.html' %}

{% block content %}
<main class="news-page">

    <!-- Submission Form -->
    <section class="news-left">
        <h2>Submit a News Link</h2>
        <form method="POST" action="{{ url_for('news') }}">
            <input type="url" name="url" placeholder="Paste news article URL here..." required>
            <br><button type="submit">Submit</button>
        </form>
    </section>

    <!-- News Feed and Comments in unified right section -->
    <section class="news-right">
        {% for article in articles %}
        <div class="news-article">
            <h2><a href="{{ article.url }}" target="_blank">{{ article.title }}</a></h2>
            <p>{{ article.description }}</p>
            <p><em>Source: {{ article.source }}</em></p>
            <p><em>Published: {{ article.published }}</em></p>
            <img src="{{ article.image_url }}" alt="Article image" width="100%" class="news-image">
            
            {% if is_admin() %}
            <form method="POST" action="{{ url_for('delete_article', article_id=article.id) }}" style="display:inline;">
                <button type="submit" onclick="return confirm('Delete this article?')">ðŸ—‘ Delete Article</button>
            </form>
            {% endif %}

            <div class="comments-thread">
                <h4>Discussion</h4>

                {% for comment in article.comments if comment.parent_id is none %}
                <div class="comment">
                    <strong>{{ comment.user.username if comment.user else 'Anonymous' }}</strong>:
                    <p>{{ comment.content }}</p>

                    {% if is_admin() %}
                    <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" style="display:inline;">
                        <button type="submit" onclick="return confirm('Delete this comment?')">ðŸ—‘ Delete</button>
                    </form>
                    {% endif %}

                    {% if session.get('user_id') %}
                    <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                        <input type="hidden" name="parent_id" value="{{ comment.id }}">
                        <textarea name="content" placeholder="Write a reply..." required></textarea>
                        <button type="submit">Reply</button>
                    </form>
                    {% endif %}

                    <div class="replies" style="margin-left: 20px;">
                        {% for reply in comment.replies %}
                        <div class="reply">
                            <strong>{{ reply.user.username if reply.user else 'Anonymous' }}</strong>:
                            <p>{{ reply.content }}</p>
                        </div>
                        {% if is_admin() %}
                        <form method="POST" action="{{ url_for('delete_comment', comment_id=reply.id) }}" style="display:inline;">
                            <button type="submit" onclick="return confirm('Delete this reply?')">ðŸ—‘ Delete</button>
                        </form>
                        {% endif %}

                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                {% if session.get('user_id') %}
                <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                    <textarea name="content" placeholder="Write a comment..." required></textarea>
                    <button type="submit">Post Comment</button>
                </form>
                {% else %}
                <p><a href="{{ url_for('login') }}">Log in</a> to comment.</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </section>

</main>
{% endblock %}
